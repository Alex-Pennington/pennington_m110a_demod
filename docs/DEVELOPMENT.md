# Development Workflow

## Git Branching Strategy

```
main (stable releases)
  │
  ├── draft (prereleases/release candidates)
  │     │
  │     └── feature branches → draft → main
  │
  └── Tags mark published releases
```

### Branch Roles

| Branch | Purpose | Protected |
|--------|---------|-----------|
| `main` | Stable releases only | Yes |
| `draft` | Prereleases, release candidates, reviewed code | Yes |
| `turbo` | Active development (current working branch) | No |
| `feature/*` | Feature development | No |
| `fix/*` | Bug fixes | No |

### Workflow

1. **Development**: Work on feature branch or `turbo`
2. **Review**: PR to `draft` for prerelease testing
3. **Publish**: PR from `draft` to `main` + tag for stable release

---

## Release Types

### Dev Builds (Continuous)
- Every `.\build.ps1` increments `BUILD_NUMBER`
- Version format: `1.2.0+build.208.34ba342`
- No signing, no artifacts
- For local development and testing

### Prereleases (Draft)
- Merged to `draft` branch
- Version format: `1.2.0-rc.1` or `1.2.0-beta.1`
- Optional signing
- GitHub prerelease (draft visibility)

### Stable Releases (Published)
- Merged from `draft` to `main`
- Tagged: `v1.2.0`
- GPG signed artifacts
- GitHub release with attestation

---

## Conventional Commits

Use conventional commit format for clear changelog generation:

```
<type>(<scope>): <subject>

[optional body]

[optional footer]
```

### Types

| Type | Description | Version Bump |
|------|-------------|--------------|
| `feat` | New feature | Minor |
| `fix` | Bug fix | Patch |
| `perf` | Performance improvement | Patch |
| `refactor` | Code refactoring | None |
| `docs` | Documentation | None |
| `test` | Tests | None |
| `chore` | Build/tooling | None |
| `BREAKING CHANGE` | Breaking API change | Major |

### Examples

```bash
# Feature
git commit -m "feat(tx): add Brain-compatible leading symbols"

# Bug fix
git commit -m "fix(rx): correct preamble detection threshold"

# Breaking change
git commit -m "feat(api)!: change encode() return type to Result<Samples>"

# With scope and body
git commit -m "fix(scrambler): correct LFSR seed value

Brain modem uses 0xBAD seed, not 0xB5D.
Fixes cross-modem interoperability."
```

---

## Version Injection

### Version Header Structure

The build system auto-generates `api/version.h` with version information:

```cpp
// In version.h (auto-generated by build.ps1)
constexpr int VERSION_MAJOR = 1;
constexpr int VERSION_MINOR = 2;
constexpr int VERSION_PATCH = 0;
constexpr const char* VERSION_PRERELEASE = "rc.1";  // Empty for stable
constexpr int BUILD_NUMBER = 208;
constexpr const char* GIT_COMMIT = "34ba342";
constexpr const char* GIT_BRANCH = "turbo";
constexpr const char* BUILD_DATE = "2025-01-15";
constexpr const char* BUILD_TIME = "14:30:00";
```

### How It Works

1. `build.ps1` reads current version from `api/version.h`
2. Increments `BUILD_NUMBER` on every build
3. Optionally increments major/minor/patch via `-Increment` flag
4. Sets prerelease tag via `-Prerelease` flag
5. Injects git commit hash and branch name
6. Writes updated `version.h`

### Build Script Usage

```powershell
# Show all options
.\build.ps1 -Help

# Normal build (increments BUILD_NUMBER only)
.\build.ps1

# Increment patch version (1.2.0 → 1.2.1)
.\build.ps1 -Increment patch

# Increment minor version (1.2.1 → 1.3.0)
.\build.ps1 -Increment minor

# Increment major version (1.3.0 → 2.0.0)
.\build.ps1 -Increment major

# Create prerelease (1.2.0-rc.1)
.\build.ps1 -Prerelease "rc.1"

# Clean build
.\build.ps1 -Clean

# Build release package
.\build.ps1 -Target release

# Release without GPG signing
.\build.ps1 -Target release -NoSign
```

---

## Artifact Naming

### Format

```
M110A_Modem_v{VERSION}_Build{BUILD}_{OS}-{ARCH}.{ext}
```

### Examples

| Scenario | Filename |
|----------|----------|
| Stable Windows x64 | `M110A_Modem_v1.2.0_Build208_windows-x64.zip` |
| Prerelease | `M110A_Modem_v1.2.0-rc.1_Build208_windows-x64.zip` |
| Linux (future) | `M110A_Modem_v1.2.0_Build208_linux-x64.tar.gz` |

### Release Artifact Contents

```
M110A_Modem_v1.2.0_Build208_win64.zip
├── m110a_server.exe        # Main server binary
├── LICENSE                 # License file
├── EULA.md                 # End User License Agreement
├── README.md               # Quick start guide
├── api/                    # Header files for integration
│   ├── modem.h
│   ├── modem_config.h
│   ├── modem_types.h
│   └── version.h
└── docs/                   # Documentation
    ├── API.md
    └── PROTOCOL.md
```

### Signature Files

Each release includes:
- `M110A_Modem_v1.2.0_Build208.zip.asc` - GPG detached signature
- `M110A_Modem_v1.2.0_Build208.SHA256.txt` - SHA256 checksum

---

## Attestation Verification

### GitHub Attestation

GitHub provides SLSA provenance attestation for releases. Verify with:

```bash
# Install GitHub CLI if needed
# https://cli.github.com/

# Verify attestation
gh attestation verify M110A_Modem_v1.2.0_Build208.zip \
    --owner Alex-Pennington \
    --repo pennington_m110a_demod
```

### GPG Signature Verification

```bash
# Import public key (from gpg/public_key.asc)
gpg --import gpg/public_key.asc

# Verify signature
gpg --verify M110A_Modem_v1.2.0_Build208_windows-x64.zip.asc M110A_Modem_v1.2.0_Build208_windows-x64.zip
```

### SHA256 Checksum Verification

```powershell
# PowerShell
(Get-FileHash -Algorithm SHA256 M110A_Modem_v1.2.0_Build208_windows-x64.zip).Hash
# Compare with contents of .SHA256.txt file
```

```bash
# Linux/macOS
sha256sum -c M110A_Modem_v1.2.0_Build208_windows-x64.SHA256.txt
```

---

## Version Bump Guidance

### When to Bump

| Change Type | Version Bump | Command |
|-------------|--------------|---------|
| Breaking API change | Major | `.\build.ps1 -Increment major` |
| New feature | Minor | `.\build.ps1 -Increment minor` |
| Bug fix | Patch | `.\build.ps1 -Increment patch` |
| Release candidate | Prerelease | `.\build.ps1 -Prerelease "rc.1"` |
| Build/internal only | Build number only | `.\build.ps1` |

### Conventional Commit Mapping

| Commit Type | Version Bump |
|-------------|--------------|
| `fix:` | `-Increment patch` |
| `feat:` | `-Increment minor` |
| `feat!:` or `BREAKING CHANGE:` | `-Increment major` |

### Where to Update

Version is managed in **one place**: `api/version.h` (auto-generated)

**Do not edit `version.h` manually** - use build script flags:

```powershell
# Patch bump (bug fix release)
.\build.ps1 -Increment patch

# Minor bump (new feature)  
.\build.ps1 -Increment minor

# Major bump (breaking change)
.\build.ps1 -Increment major

# Prerelease
.\build.ps1 -Prerelease "beta.1"
```

**Note:** `BUILD_NUMBER`, `GIT_COMMIT`, `GIT_BRANCH`, `BUILD_DATE`, and `BUILD_TIME` are auto-generated on each build.

---

## Release Checklist

### Pre-Release
- [ ] All tests passing (`.\build.ps1 -Target test`)
- [ ] Version bumped appropriately
- [ ] CHANGELOG updated (if maintained)
- [ ] Documentation updated for new features

### Automated Release (Recommended)

```powershell
# One-command stable release (pushes to master, triggers CI)
.\build.ps1 -Target release -Increment minor -Publish

# One-command prerelease
.\build.ps1 -Target release -Prerelease "rc.1" -Publish -Draft
```

This automatically:
1. Bumps version
2. Builds all release components
3. Creates release package (ZIP)
4. GPG signs the archive
5. Generates SHA256 checksum
6. Commits version bump
7. Pushes current branch to remote
8. Pushes to default branch (`master`) to trigger CI
9. CI auto-generates tag and creates GitHub release

### Manual Release Steps (Alternative)

```powershell
# 1. Ensure clean working directory
git status

# 2. Bump version (choose one based on changes)
.\build.ps1 -Increment minor  # or patch/major

# 3. Build and test all targets
.\build.ps1 -Target all

# 4. Commit version bump
git add api/version.h
git commit -m "chore(release): bump version to 1.3.0"

# 5. Create release package (includes GPG signing)
.\build.ps1 -Target release

# 6. Push and tag
git push origin turbo
git tag -a v1.3.0 -m "Release v1.3.0"
git push origin v1.3.0

# 7. Create GitHub release manually or with gh CLI
gh release create v1.3.0 *.zip *.asc *.SHA256.txt --title "M110A Modem v1.3.0"

# 8. Create attestation (optional)
gh attestation create M110A_Modem_v1.3.0_Build210_windows-x64.zip --owner Alex-Pennington
```

### Prerelease Steps

```powershell
# Automated (recommended)
.\build.ps1 -Target release -Prerelease "rc.1" -Publish -Draft

# Or manual:
# 1. Set prerelease version and build
.\build.ps1 -Target release -Prerelease "rc.1" -NoSign

# 2. Publish as draft
.\build.ps1 -Target release -Publish -Draft
```

### Post-Release
- [ ] Verify GitHub release published
- [ ] Verify attestation available: `gh attestation verify <file> --owner Alex-Pennington`
- [ ] Test download and verification
- [ ] Announce release (if applicable)

---

## Quick Reference

```
Build Script:   .\build.ps1 [-Target <target>] [-Increment <type>] [-Prerelease <tag>] 
                           [-Clean] [-NoSign] [-Publish] [-Draft] [-Help]

Targets:        server, test, unified, unit, gui, license, release, all
Increments:     major, minor, patch
Prereleases:    "alpha.1", "beta.1", "rc.1"

Quick Commands:
  .\build.ps1                                    # Dev build
  .\build.ps1 -Target release -Publish           # Full release to GitHub
  .\build.ps1 -Target release -Publish -Draft    # Draft release
  .\build.ps1 -Increment patch -Publish          # Bug fix release

Branch Flow:    feature → turbo → draft → main → tag
Commit Format:  type(scope): description
Version Format: MAJOR.MINOR.PATCH[-PRERELEASE]+build.NUM.COMMIT
Artifact Format: M110A_Modem_v{VER}_Build{NUM}_{OS}-{ARCH}.zip

Verify Release:
  gpg --verify <file>.asc <file>.zip
  gh attestation verify <file>.zip --owner Alex-Pennington
```
