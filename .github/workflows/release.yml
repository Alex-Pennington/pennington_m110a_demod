name: Build and Release

on:
  push:
    branches:
      - master
    paths:
      - 'api/version.h'

permissions:
  contents: write
  id-token: write
  attestations: write

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Extract version from version.h
        id: version
        shell: pwsh
        run: |
          $content = Get-Content api/version.h -Raw
          $major = if ($content -match 'VERSION_MAJOR = (\d+)') { $Matches[1] } else { "0" }
          $minor = if ($content -match 'VERSION_MINOR = (\d+)') { $Matches[1] } else { "0" }
          $patch = if ($content -match 'VERSION_PATCH = (\d+)') { $Matches[1] } else { "0" }
          $build = if ($content -match 'BUILD_NUMBER = (\d+)') { $Matches[1] } else { "0" }
          $prerelease = if ($content -match 'VERSION_PRERELEASE = "([^"]*)"') { $Matches[1] } else { "" }
          
          $version = "$major.$minor.$patch"
          $tag = "v$version"
          if ($prerelease) {
            $tag = "v$version-$prerelease"
          }
          
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "tag=$tag" >> $env:GITHUB_OUTPUT
          echo "build=$build" >> $env:GITHUB_OUTPUT
          echo "Version: $version, Tag: $tag, Build: $build"

      - name: Check if tag exists
        id: check_tag
        shell: pwsh
        run: |
          $tag = "${{ steps.version.outputs.tag }}"
          git fetch --tags
          $exists = git tag -l $tag
          if ($exists) {
            echo "exists=true" >> $env:GITHUB_OUTPUT
            echo "Tag $tag already exists - skipping release"
          } else {
            echo "exists=false" >> $env:GITHUB_OUTPUT
            echo "Tag $tag does not exist - will create release"
          }

      - name: Create tag
        if: steps.check_tag.outputs.exists == 'false'
        shell: pwsh
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag ${{ steps.version.outputs.tag }}
          git push origin ${{ steps.version.outputs.tag }}

      - uses: msys2/setup-msys2@v2
        if: steps.check_tag.outputs.exists == 'false'
        with:
          msystem: MINGW64
          update: true
          install: mingw-w64-x86_64-gcc mingw-w64-x86_64-cmake mingw-w64-x86_64-make make

      - name: Build executables
        if: steps.check_tag.outputs.exists == 'false'
        shell: msys2 {0}
        run: |
          g++ -std=c++17 -O2 -I. -Isrc -D_USE_MATH_DEFINES -static \
            -o server/m110a_server.exe \
            server/main.cpp server/brain_server.cpp api/modem_tx.cpp api/modem_rx.cpp \
            -lws2_32
          
          g++ -std=c++17 -O2 -I. -Isrc -D_USE_MATH_DEFINES -static \
            -o test/exhaustive_test.exe \
            test/exhaustive_test_unified.cpp api/modem_tx.cpp api/modem_rx.cpp src/io/pcm_file.cpp \
            -lws2_32
          
          g++ -std=c++17 -O2 -I. -Isrc -Iextern -Iextern/brain_core -D_USE_MATH_DEFINES -static \
            -o test/brain_exhaustive_test.exe \
            test/brain_exhaustive_test.cpp \
            extern/brain_core/m188110a/g110a.cpp \
            extern/brain_core/m188110a/de110a.cpp \
            extern/brain_core/m188110a/eq110a.cpp \
            extern/brain_core/m188110a/in110a.cpp \
            extern/brain_core/m188110a/ptx110a.cpp \
            extern/brain_core/m188110a/rxm110a.cpp \
            extern/brain_core/m188110a/t110a.cpp \
            extern/brain_core/m188110a/txm110a.cpp \
            extern/brain_core/m188110a/v110a.cpp \
            -lws2_32
          
          g++ -std=c++17 -O2 -I. -Isrc -Iextern -Iextern/brain_core -D_USE_MATH_DEFINES -static \
            -o test/interop_test.exe \
            test/interop_test.cpp api/modem_tx.cpp api/modem_rx.cpp \
            extern/brain_core/m188110a/g110a.cpp \
            extern/brain_core/m188110a/de110a.cpp \
            extern/brain_core/m188110a/eq110a.cpp \
            extern/brain_core/m188110a/in110a.cpp \
            extern/brain_core/m188110a/ptx110a.cpp \
            extern/brain_core/m188110a/rxm110a.cpp \
            extern/brain_core/m188110a/t110a.cpp \
            extern/brain_core/m188110a/txm110a.cpp \
            extern/brain_core/m188110a/v110a.cpp \
            -lws2_32
          
          if [ -f "test/test_gui/main.cpp" ]; then
            g++ -std=c++17 -O2 -I. -Isrc -D_USE_MATH_DEFINES -static \
              -o test/test_gui.exe \
              test/test_gui/main.cpp \
              -lws2_32 -lshell32
          else
            g++ -std=c++17 -O2 -I. -Isrc -D_USE_MATH_DEFINES -static \
              -o test/test_gui.exe \
              test/test_gui_server.cpp \
              -lws2_32 -lshell32
          fi
          
          # HF Channel Simulator
          g++ -std=c++17 -O2 -I. -Isrc -D_USE_MATH_DEFINES -static \
            -o hfchansim/hfchansim.exe \
            hfchansim/main.cpp \
            -lws2_32

      # MELPe removed - ETSI/TI licensed code
      # Codec2 - Open Source (LGPL) voice codec by David Rowe VK5DGR
      - name: Build Codec2 vocoder
        if: steps.check_tag.outputs.exists == 'false'
        shell: msys2 {0}
        run: |
          cd extern/codec2
          rm -rf build_win
          mkdir -p build_win && cd build_win
          cmake .. -G "MSYS Makefiles" -DCMAKE_BUILD_TYPE=Release
          cmake --build . --target codec2
          cd ../../../src/codec2_vocoder
          rm -rf build
          mkdir -p build && cd build
          cmake .. -G "MSYS Makefiles" -DCMAKE_BUILD_TYPE=Release
          cmake --build .

      - name: Package release
        if: steps.check_tag.outputs.exists == 'false'
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $build = "${{ steps.version.outputs.build }}"
          
          New-Item -ItemType Directory -Force -Path release/bin
          New-Item -ItemType Directory -Force -Path release/docs
          New-Item -ItemType Directory -Force -Path release/examples
          
          Copy-Item server/m110a_server.exe release/bin/
          Copy-Item test/exhaustive_test.exe release/bin/
          Copy-Item test/brain_exhaustive_test.exe release/bin/
          Copy-Item test/interop_test.exe release/bin/
          Copy-Item test/test_gui.exe release/bin/
          Copy-Item hfchansim/hfchansim.exe release/bin/
          Copy-Item src/codec2_vocoder/build/codec2_vocoder.exe release/bin/
          
          Copy-Item README.md release/
          if (Test-Path docs/PROTOCOL.md) { Copy-Item docs/PROTOCOL.md release/docs/ }
          if (Test-Path docs/CHANNEL_SIMULATION.md) { Copy-Item docs/CHANNEL_SIMULATION.md release/docs/ }
          if (Test-Path docs/API.md) { Copy-Item docs/API.md release/docs/ }
          if (Test-Path hfchansim/README.md) { Copy-Item hfchansim/README.md release/docs/HFCHANSIM.md }
          
          if (Test-Path refrence_pcm) { 
            Copy-Item refrence_pcm release/examples/refrence_pcm -Recurse
          }
          
          if (Test-Path src/melpe_core/test_audio) {
            Copy-Item src/melpe_core/test_audio release/examples/melpe_test_audio -Recurse
          }
          
          # Create INSTALL.md
          $install = "# M110A Modem Installation Guide`n`n"
          $install += "## Quick Start`n`n"
          $install += "1. Run test_gui.exe and open http://localhost:8080`n"
          $install += "2. Or run: exhaustive_test.exe --help`n`n"
          $install += "## Components`n`n"
          $install += "- m110a_server.exe - TCP/IP modem server (ports 4998/4999)`n"
          $install += "- exhaustive_test.exe - PhoenixNest modem test suite`n"
          $install += "- brain_exhaustive_test.exe - Brain modem test suite`n"
          $install += "- interop_test.exe - PhoenixNest/Brain interoperability test`n"
          $install += "- test_gui.exe - Web GUI for all tests`n"
          $install += "- hfchansim.exe - HF channel simulator (Watterson/AWGN)`n"
          $install += "- codec2_vocoder.exe - Codec2 voice codec (LGPL)`n`n"
          $install += "## HF Channel Simulator`n`n"
          $install += "Apply realistic HF channel impairments to test modem performance:`n`n"
          $install += "  hfchansim.exe --list-ref              # List reference PCM files`n"
          $install += "  hfchansim.exe --ref 600S --preset moderate`n"
          $install += "  hfchansim.exe --help                   # Full documentation`n`n"
          $install += "## Support`n`n"
          $install += "alex.pennington@organicengineer.com`n"
          Set-Content -Path release/INSTALL.md -Value $install
          
          # Create RELEASE_INFO.txt
          $info = "M110A Modem v$version Build $build`n"
          $info += "Platform: windows-x64`n"
          $info += "Date: $(Get-Date -Format 'yyyy-MM-dd')`n`n"
          $info += "(c) 2024-2025 Alex Pennington`n"
          $info += "alex.pennington@organicengineer.com`n"
          Set-Content -Path release/RELEASE_INFO.txt -Value $info
          
          $zipName = "M110A_Modem_v${version}_Build${build}_windows-x64.zip"
          Compress-Archive -Path release/* -DestinationPath $zipName
          
          $hash = (Get-FileHash $zipName -Algorithm SHA256).Hash
          $shaContent = "SHA256: $hash`nFile: $zipName`nDate: $(Get-Date -Format 'yyyy-MM-dd')"
          Set-Content -Path "${zipName}.sha256" -Value $shaContent
          
          Write-Host "Created: $zipName"
          Write-Host "SHA256: $hash"

      - name: Generate attestation
        if: steps.check_tag.outputs.exists == 'false'
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: 'M110A_Modem_*.zip'

      - name: Create GitHub Release
        if: steps.check_tag.outputs.exists == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: M110A Modem ${{ steps.version.outputs.tag }}
          body: |
            ## M110A Modem ${{ steps.version.outputs.tag }}
            
            MIL-STD-188-110A Compatible HF Modem
            
            ### Downloads
            - **M110A_Modem_*.zip** - Complete release package
            
            ### Quick Start
            Run `test_gui.exe` then open http://localhost:8080
            
            ### Included
            - m110a_server.exe - TCP/IP modem server
            - exhaustive_test.exe - PhoenixNest test suite
            - brain_exhaustive_test.exe - Brain modem test suite
            - interop_test.exe - Cross-implementation interoperability test
            - test_gui.exe - Web GUI for all tests
            - hfchansim.exe - HF channel simulator (Watterson model, CCIR presets)
            - codec2_vocoder.exe - Codec2 voice codec (LGPL, by VK5DGR)
            - Reference PCM files for all 12 modes
            
            ---
            Build ${{ steps.version.outputs.build }} | Auto-release with attestation
          files: |
            M110A_Modem_*.zip
            M110A_Modem_*.sha256
