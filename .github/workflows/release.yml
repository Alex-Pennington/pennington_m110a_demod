name: Build and Release

on:
  push:
    branches:
      - master
    paths:
      - 'api/version.h'

permissions:
  contents: write
  id-token: write
  attestations: write

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Extract version from version.h
        id: version
        shell: pwsh
        run: |
          $content = Get-Content api/version.h -Raw
          $major = if ($content -match 'VERSION_MAJOR = (\d+)') { $Matches[1] } else { "0" }
          $minor = if ($content -match 'VERSION_MINOR = (\d+)') { $Matches[1] } else { "0" }
          $patch = if ($content -match 'VERSION_PATCH = (\d+)') { $Matches[1] } else { "0" }
          $build = if ($content -match 'BUILD_NUMBER = (\d+)') { $Matches[1] } else { "0" }
          $prerelease = if ($content -match 'VERSION_PRERELEASE = "([^"]*)"') { $Matches[1] } else { "" }
          
          $version = "$major.$minor.$patch"
          $tag = "v$version"
          if ($prerelease) {
            $tag = "v$version-$prerelease"
          }
          
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "tag=$tag" >> $env:GITHUB_OUTPUT
          echo "build=$build" >> $env:GITHUB_OUTPUT
          echo "Version: $version, Tag: $tag, Build: $build"

      - name: Check if tag exists
        id: check_tag
        shell: pwsh
        run: |
          $tag = "${{ steps.version.outputs.tag }}"
          git fetch --tags
          $exists = git tag -l $tag
          if ($exists) {
            echo "exists=true" >> $env:GITHUB_OUTPUT
            echo "Tag $tag already exists - skipping release"
          } else {
            echo "exists=false" >> $env:GITHUB_OUTPUT
            echo "Tag $tag does not exist - will create release"
          }

      - name: Create tag
        if: steps.check_tag.outputs.exists == 'false'
        shell: pwsh
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag ${{ steps.version.outputs.tag }}
          git push origin ${{ steps.version.outputs.tag }}

      - uses: msys2/setup-msys2@v2
        if: steps.check_tag.outputs.exists == 'false'
        with:
          msystem: MINGW64
          update: true
          install: mingw-w64-x86_64-gcc mingw-w64-x86_64-cmake mingw-w64-x86_64-make make

      - name: Build executables
        if: steps.check_tag.outputs.exists == 'false'
        shell: msys2 {0}
        run: |
          # Main modem server (TX/RX via TCP)
          g++ -std=c++17 -O2 -I. -Isrc -D_USE_MATH_DEFINES -static \
            -o server/m110a_server.exe \
            server/main.cpp api/modem_tx.cpp api/modem_rx.cpp \
            -lws2_32
          
          # Web-based test GUI
          g++ -std=c++17 -O2 -I. -Isrc -D_USE_MATH_DEFINES -static \
            -o test/test_gui.exe \
            test/test_gui/main.cpp \
            -lws2_32 -lshell32
          
          # I/Q Pipeline Tests (SDR support)
          g++ -std=c++17 -O2 -I. -D_USE_MATH_DEFINES -static \
            -o test/test_sample_source.exe \
            test/test_sample_source.cpp
          
          g++ -std=c++17 -O2 -I. -D_USE_MATH_DEFINES -static \
            -o test/test_iq_file_source.exe \
            test/test_iq_file_source.cpp
          
          g++ -std=c++17 -O2 -I. -D_USE_MATH_DEFINES -static \
            -o test/test_iq_loopback.exe \
            test/test_iq_loopback.cpp

      # MELPe removed - ETSI/TI licensed code
      # Codec2 - Open Source (LGPL) voice codec by David Rowe VK5DGR
      - name: Build Codec2 vocoder
        if: steps.check_tag.outputs.exists == 'false'
        shell: msys2 {0}
        run: |
          cd extern/codec2
          rm -rf build_win
          mkdir -p build_win && cd build_win
          cmake .. -G "MSYS Makefiles" -DCMAKE_BUILD_TYPE=Release
          cmake --build . --target codec2
          cd ../../../src/codec2_vocoder
          rm -rf build
          mkdir -p build && cd build
          cmake .. -G "MSYS Makefiles" -DCMAKE_BUILD_TYPE=Release
          cmake --build .

      - name: Package release
        if: steps.check_tag.outputs.exists == 'false'
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $build = "${{ steps.version.outputs.build }}"
          
          New-Item -ItemType Directory -Force -Path release/bin
          New-Item -ItemType Directory -Force -Path release/docs
          New-Item -ItemType Directory -Force -Path release/examples
          
          # Main executables
          Copy-Item server/m110a_server.exe release/bin/
          Copy-Item test/test_gui.exe release/bin/
          Copy-Item src/codec2_vocoder/build/codec2_vocoder.exe release/bin/
          
          # I/Q Pipeline tests (SDR support)
          Copy-Item test/test_sample_source.exe release/bin/
          Copy-Item test/test_iq_file_source.exe release/bin/
          Copy-Item test/test_iq_loopback.exe release/bin/
          
          # Documentation
          Copy-Item README.md release/
          Copy-Item SDRPlay_Integration_Pathway.md release/docs/
          if (Test-Path docs/PROTOCOL.md) { Copy-Item docs/PROTOCOL.md release/docs/ }
          if (Test-Path docs/API.md) { Copy-Item docs/API.md release/docs/ }
          
          if (Test-Path refrence_pcm) { 
            Copy-Item refrence_pcm release/examples/refrence_pcm -Recurse
          }
          
          # Create INSTALL.md
          $install = "# M110A Modem Installation Guide`n`n"
          $install += "## Quick Start`n`n"
          $install += "1. Run test_gui.exe and open http://localhost:8080`n"
          $install += "2. Or run: m110a_server.exe to start TCP modem server`n`n"
          $install += "## Components`n`n"
          $install += "- m110a_server.exe - TCP/IP modem server (ports 4998/4999/5000)`n"
          $install += "- test_gui.exe - Web GUI for testing`n"
          $install += "- codec2_vocoder.exe - Codec2 voice codec (LGPL)`n`n"
          $install += "## SDR I/Q Pipeline Tests`n`n"
          $install += "These validate the SDRplay RSP2 Pro integration pathway:`n`n"
          $install += "- test_sample_source.exe - IQSource/AudioSource format tests`n"
          $install += "- test_iq_file_source.exe - .iqr file reader tests`n"
          $install += "- test_iq_loopback.exe - I/Q signal integrity tests`n`n"
          $install += "All 31 I/Q tests pass with:`n"
          $install += "- Signal amplitude preserved (rms_ratio = 1.00)`n"
          $install += "- int16 quantization SNR: 82.2 dB`n"
          $install += "- Format consistency: planar == interleaved`n`n"
          $install += "## SDR Integration`n`n"
          $install += "See SDRPlay_Integration_Pathway.md for connecting phoenix_sdr to the modem.`n`n"
          $install += "## Support`n`n"
          $install += "alex.pennington@organicengineer.com`n"
          Set-Content -Path release/INSTALL.md -Value $install
          
          # Create RELEASE_INFO.txt
          $info = "M110A Modem v$version Build $build`n"
          $info += "Platform: windows-x64`n"
          $info += "Date: $(Get-Date -Format 'yyyy-MM-dd')`n`n"
          $info += "(c) 2024-2025 Alex Pennington`n"
          $info += "alex.pennington@organicengineer.com`n"
          Set-Content -Path release/RELEASE_INFO.txt -Value $info
          
          $zipName = "M110A_Modem_v${version}_Build${build}_windows-x64.zip"
          Compress-Archive -Path release/* -DestinationPath $zipName
          
          $hash = (Get-FileHash $zipName -Algorithm SHA256).Hash
          $shaContent = "SHA256: $hash`nFile: $zipName`nDate: $(Get-Date -Format 'yyyy-MM-dd')"
          Set-Content -Path "${zipName}.sha256" -Value $shaContent
          
          Write-Host "Created: $zipName"
          Write-Host "SHA256: $hash"

      - name: Generate attestation
        if: steps.check_tag.outputs.exists == 'false'
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: 'M110A_Modem_*.zip'

      - name: Create GitHub Release
        if: steps.check_tag.outputs.exists == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: M110A Modem ${{ steps.version.outputs.tag }}
          body: |
            ## M110A Modem ${{ steps.version.outputs.tag }}
            
            MIL-STD-188-110A Compatible HF Modem with **SDR I/Q Support**
            
            ### What's New
            - ✅ **SDR Integration Ready** - Direct I/Q input from SDRplay RSP2 Pro (2 MSPS)
            - ✅ **IQSource/IQFileSource** - Multi-stage decimation (2 MSPS → 48 kHz)
            - ✅ **.iqr file playback** - Compatible with phoenix_sdr recordings
            - ✅ **31/31 I/Q pipeline tests passing**
            
            ### Downloads
            - **M110A_Modem_*.zip** - Complete release package
            
            ### Quick Start
            Run `test_gui.exe` then open http://localhost:8080
            
            ### Included
            - m110a_server.exe - TCP/IP modem server (TX/RX)
            - test_gui.exe - Web GUI for testing
            - codec2_vocoder.exe - Codec2 voice codec (LGPL, by VK5DGR)
            - test_sample_source.exe - I/Q format conversion tests
            - test_iq_file_source.exe - .iqr file reader tests
            - test_iq_loopback.exe - I/Q signal integrity validation
            
            ### SDR Integration
            See `SDRPlay_Integration_Pathway.md` for connecting phoenix_sdr to the modem.
            
            ---
            Build ${{ steps.version.outputs.build }} | Auto-release with attestation
          files: |
            M110A_Modem_*.zip
            M110A_Modem_*.sha256
