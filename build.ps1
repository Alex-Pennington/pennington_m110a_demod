# build.ps1 - M110A Modem Build Script with Version Management
# Usage: .\build.ps1 [-Target <server|test|all>] [-Increment <major|minor|patch>] [-Clean]

param(
    [string]$Target = "all",
    [string]$Increment = "",
    [switch]$Clean = $false
)

$ErrorActionPreference = "Stop"
$ProjectRoot = $PSScriptRoot
$VersionFile = Join-Path $ProjectRoot "api\version.h"

# ============================================================
# Version Management
# ============================================================

function Get-CurrentVersion {
    if (-not (Test-Path $VersionFile)) {
        return @{ Major = 1; Minor = 0; Patch = 0; Build = 0 }
    }
    
    $content = Get-Content $VersionFile -Raw
    $major = if ($content -match 'VERSION_MAJOR = (\d+)') { [int]$Matches[1] } else { 1 }
    $minor = if ($content -match 'VERSION_MINOR = (\d+)') { [int]$Matches[1] } else { 0 }
    $patch = if ($content -match 'VERSION_PATCH = (\d+)') { [int]$Matches[1] } else { 0 }
    $build = if ($content -match 'BUILD_NUMBER = (\d+)') { [int]$Matches[1] } else { 0 }
    
    return @{ Major = $major; Minor = $minor; Patch = $patch; Build = $build }
}

function Update-Version {
    param($Version, $IncrementType)
    
    switch ($IncrementType) {
        "major" { 
            $Version.Major++
            $Version.Minor = 0
            $Version.Patch = 0
        }
        "minor" {
            $Version.Minor++
            $Version.Patch = 0
        }
        "patch" {
            $Version.Patch++
        }
    }
    
    # Always increment build number
    $Version.Build++
    
    return $Version
}

function Write-VersionHeader {
    param($Version)
    
    # Get git info
    $gitCommit = (git rev-parse --short HEAD 2>$null) -replace '\s',''
    if (-not $gitCommit) { $gitCommit = "unknown" }
    
    $gitBranch = (git rev-parse --abbrev-ref HEAD 2>$null) -replace '\s',''
    if (-not $gitBranch) { $gitBranch = "unknown" }
    
    $buildDate = Get-Date -Format "yyyy-MM-dd"
    $buildTime = Get-Date -Format "HH:mm:ss"
    
    $header = @"
/**
 * @file version.h
 * @brief Auto-generated version information
 * 
 * M110A Modem - MIL-STD-188-110A Compatible HF Modem
 * Copyright (c) 2024-2025 Alex Pennington
 * Email: alex.pennington@organicengineer.com
 * 
 * DO NOT EDIT MANUALLY - Generated by build.ps1
 */

#ifndef M110A_VERSION_H
#define M110A_VERSION_H

#include <string>

namespace m110a {

// Semantic version
constexpr int VERSION_MAJOR = $($Version.Major);
constexpr int VERSION_MINOR = $($Version.Minor);
constexpr int VERSION_PATCH = $($Version.Patch);

// Build information (auto-generated)
constexpr int BUILD_NUMBER = $($Version.Build);
constexpr const char* GIT_COMMIT = "$gitCommit";
constexpr const char* GIT_BRANCH = "$gitBranch";
constexpr const char* BUILD_DATE = "$buildDate";
constexpr const char* BUILD_TIME = "$buildTime";

/// Get version string (e.g., "1.2.0")
inline std::string version() {
    return std::to_string(VERSION_MAJOR) + "." +
           std::to_string(VERSION_MINOR) + "." +
           std::to_string(VERSION_PATCH);
}

/// Get full version string with branch and build info
/// Format: "1.2.0 (turbo) build.42.abc1234"
inline std::string version_full() {
    return version() + " (" + GIT_BRANCH + ") build." + 
           std::to_string(BUILD_NUMBER) + "." + GIT_COMMIT;
}

/// Get build info string for reports
/// Format: "Build 42 (abc1234) turbo 2025-12-08 07:30:00"
inline std::string build_info() {
    return std::string("Build ") + std::to_string(BUILD_NUMBER) + 
           " (" + GIT_COMMIT + ") " + GIT_BRANCH + " " + BUILD_DATE + " " + BUILD_TIME;
}

/// Get version for help/usage display
/// Format: "v1.2.0-turbo+42"
inline std::string version_short() {
    return "v" + version() + "-" + GIT_BRANCH + "+" + std::to_string(BUILD_NUMBER);
}

/// Get detailed version info for headers
/// Format: "M110A Modem v1.2.0 (turbo branch, build 42, commit abc1234)"
inline std::string version_header() {
    return std::string("M110A Modem v") + version() + " (" + GIT_BRANCH + 
           " branch, build " + std::to_string(BUILD_NUMBER) + ", commit " + GIT_COMMIT + ")";
}

/// Get copyright notice
inline std::string copyright_notice() {
    return "Copyright (c) 2024-2025 Alex Pennington\n"
           "Email: alex.pennington@organicengineer.com\n"
           "MIL-STD-188-110A Compatible HF Modem";
}

/// Get EULA acceptance notice
inline std::string eula_notice() {
    return "By using this software, you agree to the End User License Agreement.\n"
           "See EULA.md for complete terms and conditions.\n"
           "License required - Contact: alex.pennington@organicengineer.com";
}

} // namespace m110a

#endif // M110A_VERSION_H
"@
    
    Set-Content -Path $VersionFile -Value $header -NoNewline
    Write-Host "Version: $($Version.Major).$($Version.Minor).$($Version.Patch)+build.$($Version.Build).$gitCommit" -ForegroundColor Cyan
}

# ============================================================
# Build Functions
# ============================================================

$CXX = "g++"
$CXXFLAGS = "-std=c++17 -O2 -I. -Isrc -D_USE_MATH_DEFINES"
$LDFLAGS = "-static -lws2_32"

function Build-Server {
    Write-Host "`n=== Building Server ===" -ForegroundColor Yellow
    
    # Kill existing server
    Get-Process m110a_server -ErrorAction SilentlyContinue | Stop-Process -Force
    Start-Sleep -Milliseconds 500
    
    $sources = @(
        "server/main.cpp",
        "server/brain_server.cpp",
        "api/modem_tx.cpp",
        "api/modem_rx.cpp"
    )
    
    $cmd = "$CXX $CXXFLAGS -o server/m110a_server.exe $($sources -join ' ') $LDFLAGS"
    Write-Host $cmd -ForegroundColor DarkGray
    
    Invoke-Expression $cmd
    
    if ($LASTEXITCODE -eq 0) {
        Write-Host "Server built successfully" -ForegroundColor Green
    } else {
        throw "Server build failed"
    }
}

function Build-ExhaustiveTest {
    Write-Host "`n=== Building Exhaustive Test ===" -ForegroundColor Yellow
    
    $cmd = "$CXX $CXXFLAGS -o server/exhaustive_server_test.exe server/exhaustive_server_test.cpp $LDFLAGS"
    Write-Host $cmd -ForegroundColor DarkGray
    
    Invoke-Expression $cmd
    
    if ($LASTEXITCODE -eq 0) {
        Write-Host "Exhaustive test built successfully" -ForegroundColor Green
    } else {
        throw "Exhaustive test build failed"
    }
}

function Build-UnifiedTest {
    Write-Host "`n=== Building Unified Exhaustive Test ===" -ForegroundColor Yellow
    
    $sources = @(
        "test/exhaustive_test_unified.cpp",
        "api/modem_tx.cpp",
        "api/modem_rx.cpp",
        "src/io/pcm_file.cpp"
    )
    
    $cmd = "$CXX $CXXFLAGS -o test/exhaustive_test.exe $($sources -join ' ') $LDFLAGS"
    Write-Host $cmd -ForegroundColor DarkGray
    
    Invoke-Expression $cmd
    
    if ($LASTEXITCODE -eq 0) {
        Write-Host "Unified test built successfully" -ForegroundColor Green
    } else {
        throw "Unified test build failed"
    }
}

function Build-UnitTests {
    Write-Host "`n=== Building Unit Tests ===" -ForegroundColor Yellow
    
    $cmd = "$CXX $CXXFLAGS -o test/test_channel_params.exe test/test_channel_params.cpp $LDFLAGS"
    Write-Host $cmd -ForegroundColor DarkGray
    
    Invoke-Expression $cmd
    
    if ($LASTEXITCODE -eq 0) {
        Write-Host "Unit tests built successfully" -ForegroundColor Green
    } else {
        throw "Unit test build failed"
    }
}

function Build-TestGui {
    Write-Host "`n=== Building Test GUI Server ===" -ForegroundColor Yellow
    
    $cmd = "$CXX $CXXFLAGS -o test/test_gui.exe test/test_gui_server.cpp $LDFLAGS -lshell32"
    Write-Host $cmd -ForegroundColor DarkGray
    
    Invoke-Expression $cmd
    
    if ($LASTEXITCODE -eq 0) {
        Write-Host "Test GUI built successfully" -ForegroundColor Green
    } else {
        throw "Test GUI build failed"
    }
}

function Build-LicenseGen {
    Write-Host "`n=== Building License Generator ===" -ForegroundColor Yellow
    
    # Create tools directory if it doesn't exist
    if (-not (Test-Path "tools")) {
        New-Item -ItemType Directory -Path "tools" | Out-Null
    }
    
    $cmd = "$CXX $CXXFLAGS -o tools/license_gen.exe tools/license_gen.cpp $LDFLAGS"
    Write-Host $cmd -ForegroundColor DarkGray
    
    Invoke-Expression $cmd
    
    if ($LASTEXITCODE -eq 0) {
        Write-Host "License generator built successfully" -ForegroundColor Green
    } else {
        throw "License generator build failed"
    }
}

function Build-MelpeVocoder {
    Write-Host "`n=== Building MELPe Vocoder ===" -ForegroundColor Yellow
    
    $melpeBuildDir = "src/melpe_core/build"
    
    # Create build directory if needed
    if (-not (Test-Path $melpeBuildDir)) {
        New-Item -ItemType Directory -Path $melpeBuildDir | Out-Null
    }
    
    # Configure with CMake
    Push-Location $melpeBuildDir
    try {
        $cmakeResult = cmake .. -G "MinGW Makefiles" 2>&1
        if ($LASTEXITCODE -ne 0) {
            Write-Host "CMake configuration failed" -ForegroundColor Red
            Write-Host $cmakeResult
            throw "MELPe CMake failed"
        }
        
        # Build melpe_vocoder target
        $buildResult = cmake --build . --target melpe_vocoder 2>&1
        if ($LASTEXITCODE -ne 0) {
            Write-Host "MELPe build failed" -ForegroundColor Red
            Write-Host $buildResult
            throw "MELPe build failed"
        }
        
        Write-Host "MELPe vocoder built successfully" -ForegroundColor Green
    }
    finally {
        Pop-Location
    }
}

function Build-Release {
    Write-Host "`n=== Building Release Package ===" -ForegroundColor Cyan
    
    # Build all release components
    Build-Server
    Build-UnifiedTest
    Build-TestGui
    Build-LicenseGen
    Build-MelpeVocoder
    
    # Create release directory structure
    $releaseDir = "release"
    $binDir = "$releaseDir/bin"
    $docsDir = "$releaseDir/docs"
    $examplesDir = "$releaseDir/examples"
    
    Write-Host "`nCreating release directory structure..." -ForegroundColor Yellow
    
    if (Test-Path $releaseDir) {
        Remove-Item $releaseDir -Recurse -Force
    }
    
    New-Item -ItemType Directory -Path $binDir | Out-Null
    New-Item -ItemType Directory -Path $docsDir | Out-Null
    New-Item -ItemType Directory -Path $examplesDir | Out-Null
    
    # Copy executables
    Write-Host "Copying executables..." -ForegroundColor Yellow
    Copy-Item "server/m110a_server.exe" $binDir
    Copy-Item "test/exhaustive_test.exe" $binDir
    Copy-Item "test/test_gui.exe" $binDir
    Copy-Item "src/melpe_core/build/melpe_vocoder.exe" $binDir
    
    # Copy documentation
    Write-Host "Copying documentation..." -ForegroundColor Yellow
    Copy-Item "README.md" $releaseDir
    Copy-Item "phoenixnestmodem_eula.md" "$releaseDir/EULA.md"
    Copy-Item "docs/PROTOCOL.md" $docsDir
    Copy-Item "docs/CHANNEL_SIMULATION.md" $docsDir
    
    # Copy reference PCM files
    Write-Host "Copying reference PCM files..." -ForegroundColor Yellow
    Copy-Item "refrence_pcm" $examplesDir -Recurse
    
    # Copy MELPe test audio files
    Write-Host "Copying MELPe test audio files..." -ForegroundColor Yellow
    $melpeTestAudioSrc = "src/melpe_core/test_audio"
    if (Test-Path $melpeTestAudioSrc) {
        Copy-Item $melpeTestAudioSrc "$examplesDir/melpe_test_audio" -Recurse
    } else {
        Write-Host "  MELPe test audio not found - run src/melpe_core/download_test_audio.ps1 first" -ForegroundColor DarkYellow
    }

    # Create license template
    Write-Host "Creating license template..." -ForegroundColor Yellow
    $licenseTemplate = @"
# M110A Modem License File
# 
# To activate this software, go to https://www.organicengineer.com/projects to obtain a license key.
# 
# Steps to activate:
# 1. Run: license_gen.exe --hwid
# 2. Visit https://www.organicengineer.com/projects and submit the hardware ID
# 3. Replace this file with the license.key file you receive
#
# Format: CUSTOMER-HWID-EXPIRY-CHECKSUM
# Example: ACME01-A3B4C5D6-20261231-9F8E7D6C
#
# For support: alex.pennington@organicengineer.com
"@
    Set-Content -Path "$releaseDir/license.key.template" -Value $licenseTemplate
    
    # Create installation guide
    Write-Host "Creating installation guide..." -ForegroundColor Yellow
        $installGuide = @"
# M110A Modem Installation Guide

## System Requirements
- Windows 10/11 (64-bit)
- 4 GB RAM minimum
- Network connection for TCP/IP server mode

## Installation Steps

1. **Extract the release package** to your desired location

2. **Activate your license**
     - Open a command prompt in the release directory
     - Run: ``license_gen.exe --hwid``
     - Go to https://www.organicengineer.com/projects to obtain a license key using your hardware ID
     - You will receive a ``license.key`` file
     - Place the ``license.key`` file in the ``bin/`` directory

3. **Verify installation**
     - Navigate to the ``bin/`` directory
     - Run: ``m110a_server.exe``
     - You should see license information and server startup

## Components

### bin/m110a_server.exe
TCP/IP server for modem operations.

Ports:
- TCP 4998: Data port
- TCP 4999: Control port
- UDP 5000: Discovery (optional)

Usage:
```
cd bin
m110a_server.exe
```

### bin/exhaustive_test.exe
Comprehensive test suite for all modem modes.

Usage:
```
cd bin
exhaustive_test.exe [options]

Options:
    --server          Use TCP/IP server backend (requires m110a_server.exe running)
    --mode MODE       Test specific mode (e.g., 600S, 1200L)
    --progressive     Run progressive SNR/frequency/multipath tests
    --csv FILE        Output results to CSV
    --help            Show all options
```

### bin/test_gui.exe
Web-based graphical interface for running tests.

Usage:
```
cd bin
test_gui.exe
```

Opens http://localhost:8080 in your browser with a full GUI for test configuration.

## Quick Start

1. Start the server:
```
cd bin
m110a_server.exe
```

2. In another terminal, run a test:
```
cd bin
exhaustive_test.exe
```

## Reference PCM Files

The ``examples/refrence_pcm/`` directory contains reference waveforms for all supported modes:
- 75 BPS (BPSK, Long/Short interleaver)
- 150 BPS (BPSK, Long/Short)
- 300 BPS (QPSK, Long/Short)
- 600 BPS (QPSK, Long/Short)
- 1200 BPS (8-PSK, Long/Short)
- 2400 BPS (8-PSK, Long/Short)

Each PCM file includes metadata in a JSON file.

## Known Limitations

- **AFC Range**: Automatic Frequency Control (AFC) is designed for ±2 Hz frequency offset
    - Offsets beyond ±5 Hz may result in reduced demodulation performance
    - For operation in challenging HF conditions with larger Doppler shifts, ensure transmitter/receiver frequency stability

## Troubleshooting

### "LICENSE REQUIRED" message
- Ensure ``license.key`` is in the same directory as the executable
- Verify license has not expired
- Check that you're running on the same hardware the license was issued for

### Server fails to start
- Check ports 4998/4999 are not in use: ``netstat -an | findstr "4998 4999"``
- Verify license is valid
- Check firewall settings

### Test failures
- Ensure reference PCM files are in correct location
- Check channel simulation parameters
- Review test_reports/ directory for detailed logs

## Support

For technical support or licensing inquiries:
- Website: https://www.organicengineer.com/projects
- Email: alex.pennington@organicengineer.com
- Documentation: See docs/ directory

## Version

See ``RELEASE_INFO.txt`` for build and version information.
"@
    Set-Content -Path "$releaseDir/INSTALL.md" -Value $installGuide
    
    # Create quick start guide
    Write-Host "Creating quick start guide..." -ForegroundColor Yellow
    $quickStart = @"
# M110A Modem Quick Start

## First Time Setup

1. Get your hardware ID:
   ``````
   license_gen.exe --hwid
   ``````

2. Go to https://www.organicengineer.com/projects to obtain a license key using your hardware ID

3. Place the ``license.key`` file in the ``bin/`` directory

## Running the Server

``````
cd bin
m110a_server.exe
``````

The server listens on TCP 4998 (data), TCP 4999 (control), and UDP 5000 (discovery).

## Running Tests

Basic test (ideal channel):
``````
cd bin
exhaustive_test.exe
``````

Test with channel simulation:
``````
exhaustive_test.exe --channel poor
``````

Server-based test:
``````
# Terminal 1
m110a_server.exe

# Terminal 2
exhaustive_test.exe --server
``````

## Next Steps

- Read ``INSTALL.md`` for detailed installation instructions
- Review ``docs/API.md`` for programming interface
- Check ``examples/refrence_pcm/`` for reference waveforms
- See ``docs/CHANNEL_SIMULATION.md`` for channel modeling details

## License

See ``EULA.md`` for license terms and conditions. Go to https://www.organicengineer.com/projects to obtain a license key.
"@
    Set-Content -Path "$releaseDir/QUICKSTART.md" -Value $quickStart
    
    # Create release info
    $version = Get-CurrentVersion
    $releaseInfo = @"
M110A Modem Release Package
Version: $($version.Major).$($version.Minor).$($version.Patch)
Build: $($version.Build)
Date: $(Get-Date -Format "yyyy-MM-dd HH:mm:ss")

MIL-STD-188-110A Compatible HF Modem
(c) 2024-2025 Alex Pennington

CONTENTS:
- bin/m110a_server.exe       - TCP/IP modem server
- bin/exhaustive_test.exe    - Comprehensive test suite
- bin/test_gui.exe           - Web-based test GUI (http://localhost:8080)
- docs/                      - API and protocol documentation
- examples/refrence_pcm/     - Reference waveform files
- INSTALL.md                 - Installation instructions
- QUICKSTART.md              - Quick start guide
- EULA.md                    - End User License Agreement
- README.md                  - Project overview

SYSTEM REQUIREMENTS:
- Windows 10/11 (64-bit)
- 4 GB RAM minimum
- Valid license key required

LICENSING:
This software requires activation with a hardware-locked license key.
Go to https://www.organicengineer.com/projects to obtain a license key.

SUPPORT:
alex.pennington@organicengineer.com
"@
    Set-Content -Path "$releaseDir/RELEASE_INFO.txt" -Value $releaseInfo
    
    Write-Host "`n=== Release Package Complete ===" -ForegroundColor Green
    Write-Host "Location: $releaseDir/" -ForegroundColor Cyan
    Write-Host "Contents:" -ForegroundColor Yellow
    Get-ChildItem $releaseDir -Recurse | ForEach-Object {
        $relativePath = $_.FullName.Replace("$(Get-Location)\$releaseDir\", "")
        if ($_.PSIsContainer) {
            Write-Host "  [DIR]  $relativePath" -ForegroundColor Blue
        } else {
            $size = "{0:N0} KB" -f ($_.Length / 1KB)
            Write-Host "  [FILE] $relativePath ($size)" -ForegroundColor Gray
        }
    }

    # Archive release package and generate checksum manifest
    Write-Host "`nCreating release archive..." -ForegroundColor Yellow
    $versionString = "$($version.Major).$($version.Minor).$($version.Patch)"
    $zipBaseName = "M110A_Modem_v$versionString`_Build$($version.Build)"
    $zipFileName = "$zipBaseName.zip"
    $zipPath = Join-Path $ProjectRoot $zipFileName
    if (Test-Path $zipPath) {
        Remove-Item $zipPath -Force
    }
    Compress-Archive -Path "$releaseDir\*" -DestinationPath $zipPath -Force
    Write-Host "Archive created: $zipFileName" -ForegroundColor Green

    # GPG signing
    $ascFileName = "$zipFileName.asc"
    $ascPath = Join-Path $ProjectRoot $ascFileName
    $gpgKeyId = "91F913C25A03B0F4"
    
    # Find GPG executable
    $gpgExe = "gpg"
    $gpgPaths = @(
        "C:\Program Files (x86)\gnupg\bin\gpg.exe",
        "C:\Program Files\Git\usr\bin\gpg.exe",
        "C:\Program Files\GnuPG\bin\gpg.exe"
    )
    foreach ($gp in $gpgPaths) {
        if (Test-Path $gp) {
            $gpgExe = $gp
            break
        }
    }
    
    Write-Host "Signing archive with GPG..." -ForegroundColor Yellow
    $gpgResult = & $gpgExe --armor --detach-sign --local-user $gpgKeyId $zipPath 2>&1
    if ($LASTEXITCODE -eq 0 -and (Test-Path $ascPath)) {
        Write-Host "GPG signature created: $ascFileName" -ForegroundColor Green
        $gpgSigned = $true
    } else {
        Write-Host "GPG signing skipped (key not available or GPG not installed)" -ForegroundColor Yellow
        Write-Host "  To enable signing: gpg --import gpg/public_key.asc" -ForegroundColor DarkGray
        $gpgSigned = $false
    }

    Write-Host "Computing SHA256 checksum..." -ForegroundColor Yellow
    $hashResult = Get-FileHash -Path $zipPath -Algorithm SHA256
    $zipInfo = Get-Item $zipPath
    $zipSizeBytes = $zipInfo.Length
    $zipSizePretty = "{0:N0}" -f $zipSizeBytes
    $zipSizeMB = "{0:N0}" -f ([math]::Round($zipSizeBytes / 1MB))
    $dateLine = Get-Date -Format "MMMM d, yyyy"
    $shaFileName = "$zipBaseName.SHA256.txt"
    $shaPath = Join-Path $ProjectRoot $shaFileName

    $shaContent = @"
M110A Modem v$versionString Build $($version.Build) - Release Package
==============================================
Author: Alex Pennington
Email:  alex.pennington@organicengineer.com
Web:    https://www.organicengineer.com/projects

Filename: $zipFileName
Size:     $zipSizePretty bytes ($zipSizeMB MB)
Date:     $dateLine

SHA256 Checksum:
$($hashResult.Hash)

Verification (Windows PowerShell):
Get-FileHash $zipFileName -Algorithm SHA256

"@

    # Add GPG signature section if signed
    if ($gpgSigned) {
        $shaContent += @"
GPG Signature Verification:
---------------------------
Signature File: $ascFileName
Signing Key:    91F913C25A03B0F4
Key Owner:      Alexander Keith Pennington <alex.pennington@organicengineer.com>

To verify the signature:
1. Import the public key from GitHub or gpg/public_key.asc:
   gpg --import public_key.asc
   
2. Verify the signature:
   gpg --verify $ascFileName $zipFileName

Expected output: "Good signature from Alexander Keith Pennington"

The signing key is linked to the author's GitHub account:
https://github.com/akpennington

"@
    }

    $shaContent += @"
Package Contents:
- bin/m110a_server.exe (TCP/IP modem server)
- bin/exhaustive_test.exe (comprehensive modem test suite)
- bin/test_gui.exe (web-based test GUI at http://localhost:8080)
- bin/melpe_vocoder.exe (MELPe voice codec - 600/1200/2400 bps)
- docs/ (protocol, channel simulation references)
- examples/refrence_pcm/ (M110A reference waveforms and metadata)
- examples/melpe_test_audio/ (MELPe test audio files - 8kHz PCM)
- INSTALL.md, QUICKSTART.md, README.md, EULA.md

Installation:
1. Extract ZIP archive
2. Read INSTALL.md
3. Go to https://www.organicengineer.com/projects to obtain a license key
4. Place license.key in bin/ directory
5. Run m110a_server.exe, exhaustive_test.exe, or test_gui.exe

Support: alex.pennington@organicengineer.com

Copyright (c) 2024-2025 Alex Pennington
MIL-STD-188-110A Compatible HF Modem
"@
    Set-Content -Path $shaPath -Value $shaContent
    Write-Host "Checksum manifest written: $shaFileName" -ForegroundColor Green
}

function Clean-Build {
    Write-Host "`n=== Cleaning ===" -ForegroundColor Yellow
    
    $exeFiles = Get-ChildItem -Path $ProjectRoot -Recurse -Include "*.exe" -ErrorAction SilentlyContinue
    foreach ($exe in $exeFiles) {
        Remove-Item $exe.FullName -Force -ErrorAction SilentlyContinue
        Write-Host "Removed: $($exe.Name)" -ForegroundColor DarkGray
    }
}

# ============================================================
# Main
# ============================================================

Write-Host "============================================" -ForegroundColor Cyan
Write-Host "M110A Modem Build System" -ForegroundColor Cyan  
Write-Host "============================================" -ForegroundColor Cyan

Set-Location $ProjectRoot

# Clean if requested
if ($Clean) {
    Clean-Build
}

# Update version
$version = Get-CurrentVersion
$version = Update-Version -Version $version -IncrementType $Increment
Write-VersionHeader -Version $version

# Build targets
switch ($Target.ToLower()) {
    "server" {
        Build-Server
    }
    "test" {
        Build-ExhaustiveTest
    }
    "unified" {
        Build-UnifiedTest
    }
    "unit" {
        Build-UnitTests
    }
    "gui" {
        Build-TestGui
    }
    "license" {
        Build-LicenseGen
    }
    "release" {
        Build-Release
    }
    "all" {
        Build-Server
        Build-ExhaustiveTest
        Build-UnifiedTest
        Build-UnitTests
        Build-TestGui
        Build-LicenseGen
    }
    default {
        Write-Host "Unknown target: $Target" -ForegroundColor Red
        Write-Host "Valid targets: server, test, unified, unit, gui, license, release, all" -ForegroundColor Yellow
        exit 1
    }
}

Write-Host "`n============================================" -ForegroundColor Cyan
Write-Host "Build Complete" -ForegroundColor Green
Write-Host "============================================" -ForegroundColor Cyan
