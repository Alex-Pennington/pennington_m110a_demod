# build.ps1 - M110A Modem Build Script with Version Management
# 
# Usage: .\build.ps1 [-Target <server|test|gui|all>] [-Increment <major|minor|patch>] [-Clean] [-j 4]
#
# Workflow:
#   Development:  .\build.ps1                      # Increments BUILD_NUMBER only
#   Bug fix:      .\build.ps1 -Increment patch     # 1.2.0 -> 1.2.1
#   Feature:      .\build.ps1 -Increment minor     # 1.2.1 -> 1.3.0  
#   Breaking:     .\build.ps1 -Increment major     # 1.3.0 -> 2.0.0
#   Publish:      git push origin master           # CI auto-tags and releases

param(
    [string]$Target = "all",
    [string]$Increment = "",
    [string]$Prerelease = "",
    [int]$j = 1,
    [switch]$Clean = $false,
    [switch]$Help = $false
)

$ErrorActionPreference = "Stop"
$ProjectRoot = $PSScriptRoot
$VersionFile = Join-Path $ProjectRoot "api\version.h"

if ($Help) {
    Write-Host @"
M110A Modem Build Script
========================

USAGE:
    .\build.ps1 [options]

OPTIONS:
    -Target <target>      Build target: server, test, unified, gui, all (default: all)
    -Increment <type>     Version increment: major, minor, patch
    -Clean                Clean build directory before building
    -j <n>                Parallel jobs for 'all' target (like make -j4)
    -Help                 Show this help message

EXAMPLES:
    .\build.ps1                          # Build all, increment build number
    .\build.ps1 -j 4                     # Parallel build with 4 jobs
    .\build.ps1 -Target server           # Build server only
    .\build.ps1 -Target gui              # Build test GUI only
    .\build.ps1 -Increment patch         # Bug fix release (1.2.0 -> 1.2.1)

PUBLISHING:
    After building, push to trigger GitHub CI:
      git add -A && git commit -m "Release vX.Y.Z"
      git push origin master
    CI will auto-tag, build, package, and create the GitHub release.
"@
    exit 0
}

# ============================================================
# Version Management
# ============================================================

function Get-CurrentVersion {
    if (-not (Test-Path $VersionFile)) {
        return @{ Major = 1; Minor = 0; Patch = 0; Build = 0; Prerelease = "" }
    }
    
    $content = Get-Content $VersionFile -Raw
    $major = if ($content -match 'VERSION_MAJOR = (\d+)') { [int]$Matches[1] } else { 1 }
    $minor = if ($content -match 'VERSION_MINOR = (\d+)') { [int]$Matches[1] } else { 0 }
    $patch = if ($content -match 'VERSION_PATCH = (\d+)') { [int]$Matches[1] } else { 0 }
    $build = if ($content -match 'BUILD_NUMBER = (\d+)') { [int]$Matches[1] } else { 0 }
    $prerelease = if ($content -match 'VERSION_PRERELEASE = "([^"]*)"') { $Matches[1] } else { "" }
    
    return @{ Major = $major; Minor = $minor; Patch = $patch; Build = $build; Prerelease = $prerelease }
}

function Get-VersionString {
    param($Version, [switch]$Full)
    
    $base = "v$($Version.Major).$($Version.Minor).$($Version.Patch)"
    if ($Version.Prerelease) {
        $base += "-$($Version.Prerelease)"
    }
    if ($Full) {
        $base += "+build.$($Version.Build)"
    }
    return $base
}

function Update-Version {
    param($Version, $IncrementType, $PrereleaseTag = "")
    
    switch ($IncrementType) {
        "major" { 
            $Version.Major++
            $Version.Minor = 0
            $Version.Patch = 0
            $Version.Prerelease = ""
        }
        "minor" {
            $Version.Minor++
            $Version.Patch = 0
            $Version.Prerelease = ""
        }
        "patch" {
            $Version.Patch++
            $Version.Prerelease = ""
        }
    }
    
    if ($PrereleaseTag) {
        $Version.Prerelease = $PrereleaseTag
    }
    
    $Version.Build++
    
    return $Version
}

function Write-VersionHeader {
    param($Version)
    
    $gitCommit = (git rev-parse --short HEAD 2>$null) -replace '\s',''
    if (-not $gitCommit) { $gitCommit = "unknown" }
    
    $gitBranch = (git rev-parse --abbrev-ref HEAD 2>$null) -replace '\s',''
    if (-not $gitBranch) { $gitBranch = "unknown" }
    
    $buildDate = Get-Date -Format "yyyy-MM-dd"
    $buildTime = Get-Date -Format "HH:mm:ss"
    
    $header = @"
/**
 * @file version.h
 * @brief Auto-generated version information
 * 
 * M110A Modem - MIL-STD-188-110A Compatible HF Modem
 * Copyright (c) 2024-2025 Alex Pennington
 * Email: alex.pennington@organicengineer.com
 * 
 * DO NOT EDIT MANUALLY - Generated by build.ps1
 */

#ifndef M110A_VERSION_H
#define M110A_VERSION_H

#include <string>

namespace m110a {

// Semantic version
constexpr int VERSION_MAJOR = $($Version.Major);
constexpr int VERSION_MINOR = $($Version.Minor);
constexpr int VERSION_PATCH = $($Version.Patch);

// Prerelease tag (empty for stable releases)
constexpr const char* VERSION_PRERELEASE = "$($Version.Prerelease)";

// Build information (auto-generated)
constexpr int BUILD_NUMBER = $($Version.Build);
constexpr const char* GIT_COMMIT = "$gitCommit";
constexpr const char* GIT_BRANCH = "$gitBranch";
constexpr const char* BUILD_DATE = "$buildDate";
constexpr const char* BUILD_TIME = "$buildTime";

/// Get version string (e.g., "1.2.0" or "1.2.0-rc.1")
inline std::string version() {
    std::string v = std::to_string(VERSION_MAJOR) + "." +
                    std::to_string(VERSION_MINOR) + "." +
                    std::to_string(VERSION_PATCH);
    if (VERSION_PRERELEASE[0] != '\0') {
        v += "-";
        v += VERSION_PRERELEASE;
    }
    return v;
}

/// Get full version string with branch and build info
inline std::string version_full() {
    return version() + " (" + GIT_BRANCH + ") build." + 
           std::to_string(BUILD_NUMBER) + "." + GIT_COMMIT;
}

/// Get build info string for reports
inline std::string build_info() {
    return std::string("Build ") + std::to_string(BUILD_NUMBER) + 
           " (" + GIT_COMMIT + ") " + GIT_BRANCH + " " + BUILD_DATE + " " + BUILD_TIME;
}

/// Get version for help/usage display
inline std::string version_short() {
    return "v" + version() + "-" + GIT_BRANCH + "+" + std::to_string(BUILD_NUMBER);
}

/// Get detailed version info for headers
inline std::string version_header() {
    return std::string("M110A Modem v") + version() + " (" + GIT_BRANCH + 
           " branch, build " + std::to_string(BUILD_NUMBER) + ", commit " + GIT_COMMIT + ")";
}

/// Get copyright notice
inline std::string copyright_notice() {
    return "Copyright (c) 2024-2025 Alex Pennington\n"
           "Email: alex.pennington@organicengineer.com\n"
           "MIL-STD-188-110A Compatible HF Modem";
}

} // namespace m110a

#endif // M110A_VERSION_H
"@
    
    Set-Content -Path $VersionFile -Value $header -NoNewline
    Write-Host "Version: $($Version.Major).$($Version.Minor).$($Version.Patch)+build.$($Version.Build).$gitCommit" -ForegroundColor Cyan
}

# ============================================================
# Build Functions
# ============================================================

$CXX = "g++"
$CXXFLAGS = "-std=c++17 -O2 -I. -Isrc -D_USE_MATH_DEFINES"
$LDFLAGS = "-static -lws2_32"

$MODEM_SOURCES = @(
    "api/modem_tx.cpp",
    "api/modem_rx.cpp"
)

$PCM_SOURCES = @(
    "src/io/pcm_file.cpp"
)

function Build-Server {
    Write-Host "`n=== Building Server ===" -ForegroundColor Yellow
    
    Get-Process m110a_server -ErrorAction SilentlyContinue | Stop-Process -Force
    Start-Sleep -Milliseconds 500
    
    $sources = @(
        "server/main.cpp",
        "server/brain_server.cpp"
    ) + $MODEM_SOURCES
    
    $cmd = "$CXX $CXXFLAGS -o server/m110a_server.exe $($sources -join ' ') $LDFLAGS"
    Write-Host $cmd -ForegroundColor DarkGray
    
    Invoke-Expression $cmd
    
    if ($LASTEXITCODE -eq 0) {
        Write-Host "Server built successfully" -ForegroundColor Green
    } else {
        throw "Server build failed"
    }
}

function Build-ExhaustiveTest {
    Write-Host "`n=== Building Exhaustive Test ===" -ForegroundColor Yellow
    
    $cmd = "$CXX $CXXFLAGS -o server/exhaustive_server_test.exe server/exhaustive_server_test.cpp $LDFLAGS"
    Write-Host $cmd -ForegroundColor DarkGray
    
    Invoke-Expression $cmd
    
    if ($LASTEXITCODE -eq 0) {
        Write-Host "Exhaustive test built successfully" -ForegroundColor Green
    } else {
        throw "Exhaustive test build failed"
    }
}

function Build-UnifiedTest {
    Write-Host "`n=== Building Unified Exhaustive Test ===" -ForegroundColor Yellow
    
    $sources = @(
        "test/exhaustive_test_unified.cpp"
    ) + $MODEM_SOURCES + $PCM_SOURCES
    
    $cmd = "$CXX $CXXFLAGS -o test/exhaustive_test.exe $($sources -join ' ') $LDFLAGS"
    Write-Host $cmd -ForegroundColor DarkGray
    
    Invoke-Expression $cmd
    
    if ($LASTEXITCODE -eq 0) {
        Write-Host "Unified test built successfully" -ForegroundColor Green
    } else {
        throw "Unified test build failed"
    }
}

function Build-UnitTests {
    Write-Host "`n=== Building Unit Tests ===" -ForegroundColor Yellow
    
    $sources = @(
        "test/test_channel_params.cpp"
    ) + $MODEM_SOURCES + $PCM_SOURCES
    
    $cmd = "$CXX $CXXFLAGS -o test/test_channel_params.exe $($sources -join ' ') $LDFLAGS"
    Write-Host $cmd -ForegroundColor DarkGray
    
    Invoke-Expression $cmd
    
    if ($LASTEXITCODE -eq 0) {
        Write-Host "Unit tests built successfully" -ForegroundColor Green
    } else {
        throw "Unit test build failed"
    }
}

function Build-TestGui {
    Write-Host "`n=== Building Test GUI Server ===" -ForegroundColor Yellow
    
    $guiSource = "test/test_gui/main.cpp"
    
    if (-not (Test-Path $guiSource)) {
        $guiSource = "test/test_gui_server.cpp"
        Write-Host "  Using legacy test_gui_server.cpp" -ForegroundColor DarkYellow
    }
    
    $cmd = "$CXX $CXXFLAGS -o test/test_gui.exe $guiSource $LDFLAGS -lshell32"
    Write-Host $cmd -ForegroundColor DarkGray
    
    Invoke-Expression $cmd
    
    if ($LASTEXITCODE -eq 0) {
        Write-Host "Test GUI built successfully" -ForegroundColor Green
    } else {
        throw "Test GUI build failed"
    }
}

function Clean-Build {
    Write-Host "`n=== Cleaning ===" -ForegroundColor Yellow
    
    $exeFiles = Get-ChildItem -Path $ProjectRoot -Recurse -Include "*.exe" -ErrorAction SilentlyContinue
    foreach ($exe in $exeFiles) {
        Remove-Item $exe.FullName -Force -ErrorAction SilentlyContinue
        Write-Host "Removed: $($exe.Name)" -ForegroundColor DarkGray
    }
}

# ============================================================
# Main
# ============================================================

Write-Host "============================================" -ForegroundColor Cyan
Write-Host "M110A Modem Build System" -ForegroundColor Cyan  
Write-Host "============================================" -ForegroundColor Cyan

$buildTimer = [System.Diagnostics.Stopwatch]::StartNew()

Set-Location $ProjectRoot

if ($Clean) {
    Clean-Build
}

# Update version
$version = Get-CurrentVersion
$version = Update-Version -Version $version -IncrementType $Increment -PrereleaseTag $Prerelease
Write-VersionHeader -Version $version

$versionStr = Get-VersionString -Version $version
$versionFull = Get-VersionString -Version $version -Full
Write-Host "`nVersion: $versionStr" -ForegroundColor Cyan
Write-Host "Full:    $versionFull" -ForegroundColor DarkGray

# Build targets
switch ($Target.ToLower()) {
    "server" {
        Build-Server
    }
    "test" {
        Build-ExhaustiveTest
    }
    "unified" {
        Build-UnifiedTest
    }
    "unit" {
        Build-UnitTests
    }
    "gui" {
        Build-TestGui
    }
    "all" {
        if ($j -gt 1) {
            Write-Host "`n=== Parallel Build (j=$j) ===" -ForegroundColor Yellow
            
            $guiSource = if (Test-Path "test/test_gui/main.cpp") { "test/test_gui/main.cpp" } else { "test/test_gui_server.cpp" }
            
            $builds = @(
                @{ Name = "Server"; Cmd = "$CXX $CXXFLAGS -o server/m110a_server.exe server/main.cpp server/brain_server.cpp api/modem_tx.cpp api/modem_rx.cpp $LDFLAGS" },
                @{ Name = "ExhaustiveTest"; Cmd = "$CXX $CXXFLAGS -o server/exhaustive_server_test.exe server/exhaustive_server_test.cpp $LDFLAGS" },
                @{ Name = "UnifiedTest"; Cmd = "$CXX $CXXFLAGS -o test/exhaustive_test.exe test/exhaustive_test_unified.cpp api/modem_tx.cpp api/modem_rx.cpp src/io/pcm_file.cpp $LDFLAGS" },
                @{ Name = "UnitTests"; Cmd = "$CXX $CXXFLAGS -o test/test_channel_params.exe test/test_channel_params.cpp api/modem_tx.cpp api/modem_rx.cpp src/io/pcm_file.cpp $LDFLAGS" },
                @{ Name = "TestGui"; Cmd = "$CXX $CXXFLAGS -o test/test_gui.exe $guiSource $LDFLAGS -lshell32" }
            )
            
            Get-Process m110a_server -ErrorAction SilentlyContinue | Stop-Process -Force
            
            $procs = @()
            $queue = [System.Collections.Queue]::new($builds)
            $running = @{}
            $failed = @()
            
            while ($queue.Count -gt 0 -or $running.Count -gt 0) {
                while ($running.Count -lt $j -and $queue.Count -gt 0) {
                    $build = $queue.Dequeue()
                    Write-Host "  [START] $($build.Name)" -ForegroundColor Cyan
                    $proc = Start-Process -FilePath "cmd.exe" -ArgumentList "/c $($build.Cmd)" -NoNewWindow -PassThru -WorkingDirectory $ProjectRoot
                    $running[$proc.Id] = $build.Name
                    $procs += $proc
                }
                
                Start-Sleep -Milliseconds 200
                foreach ($proc in @($procs)) {
                    if ($proc.HasExited -and $running.ContainsKey($proc.Id)) {
                        $name = $running[$proc.Id]
                        if ($proc.ExitCode -eq 0) {
                            Write-Host "  [DONE]  $name" -ForegroundColor Green
                        } else {
                            Write-Host "  [FAIL]  $name (exit code $($proc.ExitCode))" -ForegroundColor Red
                            $failed += $name
                        }
                        $running.Remove($proc.Id)
                        $procs = $procs | Where-Object { $_.Id -ne $proc.Id }
                    }
                }
            }
            
            if ($failed.Count -gt 0) {
                Write-Host "`nFailed targets: $($failed -join ', ')" -ForegroundColor Red
                throw "Parallel build failed"
            }
            Write-Host "`nAll $($builds.Count) targets built successfully" -ForegroundColor Green
        } else {
            Build-Server
            Build-ExhaustiveTest
            Build-UnifiedTest
            Build-UnitTests
            Build-TestGui
        }
    }
    default {
        Write-Host "Unknown target: $Target" -ForegroundColor Red
        Write-Host "Valid targets: server, test, unified, unit, gui, all" -ForegroundColor Yellow
        exit 1
    }
}

# Show next steps
Write-Host "`n=== To Publish ===" -ForegroundColor Cyan
Write-Host "Commit and push to master:" -ForegroundColor Yellow
Write-Host "  git add -A" -ForegroundColor DarkCyan
Write-Host "  git commit -m `"Release $versionStr`"" -ForegroundColor DarkCyan
Write-Host "  git push origin master" -ForegroundColor DarkCyan
Write-Host "`nCI will auto-tag, build, and create GitHub release." -ForegroundColor Green

$buildTimer.Stop()
$elapsed = $buildTimer.Elapsed

Write-Host "`n============================================" -ForegroundColor Cyan
Write-Host "Build Complete" -ForegroundColor Green
Write-Host "Time: $($elapsed.Minutes)m $($elapsed.Seconds).$($elapsed.Milliseconds.ToString('000'))s" -ForegroundColor Yellow
Write-Host "============================================" -ForegroundColor Cyan
